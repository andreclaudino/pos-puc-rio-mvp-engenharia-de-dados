bundle:
  name: ingest-awin

resources:
  jobs:
    ingest_to_bronze:
      name: ingest_to_bronze

      email_notifications:
       on_failure:
         - ceberiloclaus@gmail.com

      # Configurações para evitar re-execuções desnecessárias
      timeout_seconds: 3600
      max_concurrent_runs: 1

      tasks:
        - task_key: default_product_info_bronze
          python_wheel_task:
            package_name: mvp
            entry_point: ingest_to_bronze
            parameters:
              - "--catalog"
              - "mvp"
              - "--schema"
              - "bronze_feeds"
              - --table
              - default_product_info
              - --source-feed-url
              - /Volumes/workspace/awin_products/raw_data/awin_feed_data/default_product_info.csv.gz
              - --remove-all-null-columns
              - --write-mode
              - overwrite
              - --metadata-path
              - /Volumes/workspace/awin_products/raw_data/awin_feed_data/bronze-table-descriptors.json
          environment_key: default

        - task_key: default_product_info_silver
          python_wheel_task:
            package_name: mvp
            entry_point: transform_default_product_info_to_silver
            parameters: [
              "--metadata-path", "/Volumes/workspace/awin_products/raw_data/awin_feed_data/bronze-table-descriptors.json",
              "--write-mode", "overwrite",
              "--catalog", "mvp",
              "--bronze-schema", "bronze_feeds",
              "--bronze-table", "default_product_info",
              "--silver-schema", "silver_feeds",
              "--silver-table", "default_product_info",
            ]
          depends_on:
          - task_key: default_product_info_bronze
          environment_key: default

        - task_key: category_price_variability_gold
          python_wheel_task:
            package_name: mvp
            entry_point: create_gold_category_price_variability
            parameters: [
              "--metadata-path", "/Volumes/workspace/awin_products/raw_data/awin_feed_data/bronze-table-descriptors.json",
              "--write-mode", "overwrite",
              "--catalog", "mvp",
              "--silver-schema", "silver_feeds",
              "--gold-schema", "gold_price_analysis",
              "--gold-table", "category_price_variability"
            ]
          depends_on:
          - task_key: default_product_info_silver
          environment_key: default

        - task_key: gold_category_price_classification
          python_wheel_task:
            package_name: mvp
            entry_point: create_gold_category_price_classification
            parameters: [
              "--metadata-path", "/Volumes/workspace/awin_products/raw_data/awin_feed_data/bronze-table-descriptors.json",
              "--write-mode", "overwrite",
              "--catalog", "mvp",
              "--silver-schema", "silver_feeds",
              "--gold-schema", "gold_price_analysis",
              "--gold-table", "category_price_classification"
            ]
          depends_on:
          - task_key: default_product_info_silver
          environment_key: default

        - task_key: gold_price_discrepancy_audit
          python_wheel_task:
            package_name: mvp
            entry_point: create_gold_price_discrepancy_audit
            parameters: [
              "--metadata-path", "/Volumes/workspace/awin_products/raw_data/awin_feed_data/bronze-table-descriptors.json",
              "--write-mode", "overwrite",
              "--catalog", "mvp",
              "--silver-schema", "silver_feeds",
              "--gold-schema", "gold_price_analysis",
              "--gold-table", "price_discrepancy_audit"
            ]
          depends_on:
          - task_key: default_product_info_silver
          - task_key: recommended_metadata_silver
          environment_key: default

        - task_key: gold_product_price_segmentation
          python_wheel_task:
            package_name: mvp
            entry_point: create_gold_product_price_segmentation
            parameters: [
              "--metadata-path", "/Volumes/workspace/awin_products/raw_data/awin_feed_data/bronze-table-descriptors.json",
              "--write-mode", "overwrite",
              "--catalog", "mvp",
              "--silver-schema", "silver_feeds",
              "--gold-schema", "gold_price_analysis",
              "--gold-table", "product_price_segmentation"
            ]
          depends_on:
          - task_key: default_product_info_silver
          environment_key: default

        - task_key: gold_merchant_category_segmentation
          python_wheel_task:
            package_name: mvp
            entry_point: create_gold_merchant_category_segmentation
            parameters: [
              "--metadata-path", "/Volumes/workspace/awin_products/raw_data/awin_feed_data/bronze-table-descriptors.json",
              "--write-mode", "overwrite",
              "--catalog", "mvp",
              "--silver-schema", "silver_feeds",
              "--gold-schema", "gold_price_analysis",
              "--gold-table", "merchant_category_segmentation"
            ]
          depends_on:
          - task_key: default_product_info_silver
          environment_key: default

        - task_key: gold_merchant_brand_offering_segmentation
          python_wheel_task:
            package_name: mvp
            entry_point: create_gold_merchant_brand_offering_segmentation
            parameters: [
              "--metadata-path", "/Volumes/workspace/awin_products/raw_data/awin_feed_data/bronze-table-descriptors.json",
              "--write-mode", "overwrite",
              "--catalog", "mvp",
              "--silver-schema", "silver_feeds",
              "--gold-schema", "gold_price_analysis",
              "--gold-table", "merchant_brand_offering_segmentation"
            ]
          depends_on:
          - task_key: default_product_info_silver
          - task_key: recommended_metadata_silver
          - task_key: product_specifications_silver
          environment_key: default

        - task_key: recommended_metadata_bronze        
          python_wheel_task:
            package_name: mvp
            entry_point: ingest_to_bronze
            parameters:
              - "--catalog"
              - "mvp"
              - "--schema"
              - "bronze_feeds"
              - --table
              - recommended_metadata
              - --source-feed-url
              - /Volumes/workspace/awin_products/raw_data/awin_feed_data/recommended_metadata.csv.gz
              - --remove-all-null-columns
              - --write-mode
              - overwrite
              - --metadata-path
              - /Volumes/workspace/awin_products/raw_data/awin_feed_data/bronze-table-descriptors.json
          environment_key: default

        - task_key: recommended_metadata_silver
          python_wheel_task:
            package_name: mvp
            entry_point: transform_recommended_metadata_silver
            parameters: [
              "--metadata-path", "/Volumes/workspace/awin_products/raw_data/awin_feed_data/bronze-table-descriptors.json",
              "--write-mode", "overwrite",
              "--catalog", "mvp",
              "--bronze-schema", "bronze_feeds",
              "--bronze-table", "recommended_metadata",
              "--silver-schema", "silver_feeds",
              "--silver-table", "recommended_metadata",
            ]
          depends_on:
          - task_key: recommended_metadata_bronze
          environment_key: default

        - task_key: gold_merchant_price_segmentation
          python_wheel_task:
            package_name: mvp
            entry_point: create_gold_merchant_price_segmentation
            parameters: [
              "--metadata-path", "/Volumes/workspace/awin_products/raw_data/awin_feed_data/bronze-table-descriptors.json",
              "--write-mode", "overwrite",
              "--catalog", "mvp",
              "--silver-schema", "silver_feeds",
              "--gold-schema", "gold_price_analysis",
              "--gold-table", "merchant_price_segmentation"
            ]
          depends_on:
          - task_key: default_product_info_silver
          - task_key: recommended_metadata_silver
          environment_key: default

        - task_key: product_specifications_bronze        
          python_wheel_task:
            package_name: mvp
            entry_point: ingest_to_bronze
            parameters:
              - "--catalog"
              - "mvp"
              - "--schema"
              - "bronze_feeds"
              - --table
              - product_specifications
              - --source-feed-url
              - /Volumes/workspace/awin_products/raw_data/awin_feed_data/product_specifications.csv.gz
              - --remove-all-null-columns
              - --write-mode
              - overwrite
              - --metadata-path
              - /Volumes/workspace/awin_products/raw_data/awin_feed_data/bronze-table-descriptors.json
          environment_key: default

        - task_key: product_specifications_silver
          python_wheel_task:
            package_name: mvp
            entry_point: transform_product_specifications_silver
            parameters: [
              "--metadata-path", "/Volumes/workspace/awin_products/raw_data/awin_feed_data/bronze-table-descriptors.json",
              "--write-mode", "overwrite",
              "--catalog", "mvp",
              "--bronze-schema", "bronze_feeds",
              "--bronze-table", "product_specifications",
              "--silver-schema", "silver_feeds",
              "--silver-table", "product_specifications",
            ]
          depends_on:
          - task_key: product_specifications_bronze
          environment_key: default

        - task_key: gold_brand_price_segmentation
          python_wheel_task:
            package_name: mvp
            entry_point: create_gold_brand_price_segmentation
            parameters: [
              "--metadata-path", "/Volumes/workspace/awin_products/raw_data/awin_feed_data/bronze-table-descriptors.json",
              "--write-mode", "overwrite",
              "--catalog", "mvp",
              "--silver-schema", "silver_feeds",
              "--gold-schema", "gold_price_analysis",
              "--gold-table", "brand_price_segmentation"
            ]
          depends_on:
          - task_key: default_product_info_silver
          - task_key: product_specifications_silver
          environment_key: default
        

      environments:
        - environment_key: default
          spec:
            environment_version: "4"
            dependencies:
              - ../dist/*.whl
